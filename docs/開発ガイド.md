# LumiDisk 開発ガイド

## 概要

このドキュメントは、LumiDiskプロジェクトの開発環境構築から、新機能の追加、テスト、デプロイまでの開発フローを説明します。

## 開発環境構築

### 必要要件

- **Java**: OpenJDK 21 以上
- **Gradle**: 9.0 以上
- **IDE**: IntelliJ IDEA または Eclipse
- **OS**: Windows 10/11、macOS 12+、Linux

### セットアップ手順

#### 1. リポジトリのクローン

```bash
git clone https://github.com/yourname/LumiDisk.git
cd LumiDisk
```

#### 2. Java環境の確認

```bash
java -version
# OpenJDK 21.0.x が表示されることを確認
```

#### 3. Gradleの確認

```bash
./gradlew --version
# Gradle 9.0.x が表示されることを確認
```

#### 4. 依存関係のダウンロード

```bash
./gradlew build
```

#### 5. IDE設定

##### IntelliJ IDEA
1. `File` → `Open` でプロジェクトを開く
2. Gradleプロジェクトとして認識されることを確認
3. `File` → `Settings` → `Editor` → `Code Style` → `Java`
   - Scheme: `Project`
   - インデント: 2 spaces
   - 行の長さ: 120

##### Eclipse
1. `File` → `Import` → `Gradle` → `Existing Gradle Project`
2. プロジェクトルートを選択
3. `Window` → `Preferences` → `Java` → `Code Style` → `Formatter`
   - インデント: 2 spaces
   - 行の長さ: 120

## 開発フロー

### 1. ブランチ戦略

#### ブランチ命名規則
- **機能開発**: `feature/機能名`
- **バグ修正**: `fix/バグ名`
- **ドキュメント**: `docs/ドキュメント名`
- **リリース**: `release/バージョン`

#### ブランチ作成例
```bash
# 新機能の開発
git checkout -b feature/pie-chart-zoom

# バグ修正
git checkout -b fix/size-sort-issue

# ドキュメント更新
git checkout -b docs/api-reference
```

### 2. 開発手順

#### 新機能の追加

1. **要件定義**
   - 機能の目的と仕様を明確化
   - ユーザーストーリーの作成

2. **設計**
   - アーキテクチャドキュメントの更新
   - クラス設計とメソッド仕様の定義

3. **実装**
   - テストファースト開発（TDD）の推奨
   - コーディング規約の遵守

4. **テスト**
   - 単体テストの作成
   - 統合テストの実行

5. **ドキュメント更新**
   - APIリファレンスの更新
   - READMEの更新

#### バグ修正

1. **問題の再現**
   - バグの再現手順を明確化
   - ログの確認

2. **原因の特定**
   - デバッグとログ分析
   - 根本原因の特定

3. **修正の実装**
   - 最小限の変更で修正
   - 回帰テストの追加

4. **検証**
   - 修正内容の動作確認
   - 既存機能への影響確認

### 3. コーディング規約

詳細は [CODING_STANDARDS.md](./CODING_STANDARDS.md) を参照してください。

#### 主要なポイント
- インデント: 2スペース
- 行の長さ: 120文字以内
- 命名規則: camelCase（変数・メソッド）、PascalCase（クラス）
- JavaDoc: すべてのpublicメソッドに記述

## テスト

### 1. 単体テスト

#### テストクラスの作成

```java
public class FileScannerTest {
  private FileScanner fileScanner;
  
  @BeforeEach
  void setUp() {
    fileScanner = new FileScanner();
  }
  
  @Test
  void testScanDirectory() {
    // テストコード
  }
}
```

#### テスト実行

```bash
# 全テストの実行
./gradlew test

# 特定のテストクラスの実行
./gradlew test --tests FileScannerTest

# テストレポートの確認
open build/reports/tests/test/index.html
```

### 2. 統合テスト

#### 実際のファイルシステムを使用したテスト

```java
@Test
void testScanWithRealFiles() throws IOException {
  // テスト用ディレクトリの作成
  Path testDir = Files.createTempDirectory("lumidisk-test");
  
  try {
    // テストファイルの作成
    Files.write(testDir.resolve("test.txt"), "test content".getBytes());
    
    // スキャンの実行
    ScanResult result = fileScanner.scan(testDir);
    
    // 結果の検証
    assertEquals(1, result.getTotalFiles());
    assertEquals("test content".length(), result.getTotalSize());
  } finally {
    // クリーンアップ
    Files.walk(testDir)
         .sorted(Comparator.reverseOrder())
         .forEach(path -> {
           try {
             Files.delete(path);
           } catch (IOException e) {
             // ログ出力
           }
         });
  }
}
```

### 3. パフォーマンステスト

#### 大量ファイルでの性能測定

```java
@Test
void testPerformanceWithLargeDirectory() throws IOException {
  // 大量のテストファイルを作成
  Path testDir = createLargeTestDirectory(10000);
  
  long startTime = System.currentTimeMillis();
  ScanResult result = fileScanner.scan(testDir);
  long endTime = System.currentTimeMillis();
  
  // 性能要件の検証
  assertTrue(endTime - startTime < 5000); // 5秒以内
  assertEquals(10000, result.getTotalFiles());
}
```

## ビルドとパッケージング

### 1. 開発ビルド

```bash
# コンパイル
./gradlew compileJava

# テスト付きビルド
./gradlew build

# クリーンビルド
./gradlew clean build
```

### 2. 実行可能JARの作成

```bash
# Fat JARの作成
./gradlew shadowJar

# 実行
java -jar build/libs/LumiDisk-all.jar
```

### 3. ネイティブパッケージの作成

#### Windows (.exe)

```bash
./gradlew jpackage
# build/jpackage/LumiDisk-1.0.0.exe が作成される
```

#### macOS (.app)

```bash
./gradlew jpackage
# build/jpackage/LumiDisk-1.0.0.app が作成される
```

## デバッグ

### 1. IDEでのデバッグ

#### IntelliJ IDEA
1. ブレークポイントの設定
2. `Debug` モードで実行
3. 変数の監視とステップ実行

#### Eclipse
1. ブレークポイントの設定
2. `Debug As` → `Java Application`
3. デバッグパースペクティブでの操作

### 2. ログデバッグ

#### ログレベルの変更

```xml
<!-- logback.xml -->
<logger name="com.example.diskanalyzer" level="DEBUG" />
```

#### ログの確認

```bash
# ログファイルの監視
tail -f logs/lumidisk.log

# エラーログの検索
grep "ERROR" logs/lumidisk.log
```

### 3. プロファイリング

#### JProfiler
- メモリ使用量の監視
- CPU使用率の分析
- ガベージコレクションの確認

#### VisualVM
- ヒープダンプの取得
- スレッドダンプの分析

## リリース

### 1. バージョン管理

#### セマンティックバージョニング
- **MAJOR**: 破壊的変更
- **MINOR**: 新機能追加
- **PATCH**: バグ修正

#### バージョン更新

```bash
# build.gradle.kts の更新
version = "1.1.0"

# タグの作成
git tag -a v1.1.0 -m "Release version 1.1.0"
git push origin v1.1.0
```

### 2. リリースノート

#### テンプレート

```markdown
# LumiDisk v1.1.0

## 新機能
- 円グラフのズーム機能
- ファイルフィルタリング機能

## 改善
- スキャン速度の向上
- UIのレスポンシブ対応

## バグ修正
- サイズソートの問題を修正
- メモリリークの問題を解決

## 破壊的変更
- なし
```

### 3. 配布

#### GitHub Releases
1. リリースページでの作成
2. バイナリファイルのアップロード
3. リリースノートの記載

#### 自動化
- GitHub Actionsでの自動ビルド
- 自動リリースの設定

## トラブルシューティング

### 1. よくある問題

#### ビルドエラー
```bash
# 依存関係のクリーンアップ
./gradlew clean
rm -rf ~/.gradle/caches
./gradlew build
```

#### 実行時エラー
```bash
# JavaFXモジュールの問題
java --module-path /path/to/javafx --add-modules javafx.controls,javafx.fxml -jar LumiDisk.jar
```

#### メモリ不足
```bash
# ヒープサイズの増加
java -Xmx2g -jar LumiDisk.jar
```

### 2. パフォーマンス問題

#### スキャン速度の改善
- 並列度の調整
- I/Oバッファサイズの最適化
- 不要なファイル属性取得の削減

#### メモリ使用量の削減
- ストリーミング処理の活用
- オブジェクトプールの使用
- ガベージコレクションの最適化

## 貢献ガイドライン

### 1. プルリクエスト

#### 作成手順
1. フォークの作成
2. 機能ブランチの作成
3. 変更の実装
4. テストの追加
5. プルリクエストの作成

#### レビュー基準
- コードの品質
- テストの充実度
- ドキュメントの更新
- パフォーマンスへの影響

### 2. イシュー報告

#### バグレポート
- 再現手順の明確化
- 環境情報の提供
- ログファイルの添付

#### 機能要求
- ユースケースの説明
- 期待する動作の詳細
- 代替案の検討

## 参考資料

- [JavaFX Documentation](https://openjfx.io/)
- [Gradle User Guide](https://docs.gradle.org/)
- [Java 21 Documentation](https://docs.oracle.com/en/java/javase/21/)
- [Logback Documentation](http://logback.qos.ch/documentation.html)

---

**最終更新**: 2025年8月31日  
**バージョン**: 1.0
